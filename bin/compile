#!/usr/bin/env ruby
system("aptitude search pdfinfo")

require 'net/https'
require 'open-uri'
require 'zlib'

#force fetch
force_fetch=true
# sync output
$stdout.sync = true

bdir=ARGV[0]
cdir=ARGV[1]
if not File.exists?(ARGV[0])
  Dir.mkdir(ARGV[0], 0777)
end
#
if not File.exists?(ARGV[1])
  Dir.mkdir(ARGV[1], 0777)
end
#
texlivehome=bdir+"/.texlive"
texlivecache=cdir+"/.texlive"
path=texlivehome+"/bin/x86_64-linux"
profiled=bdir+"/.profile.d/texlive.sh"
pdfinfohome=bdir+"/.pdfinfo"
pdfinfov="xpdfbin-linux-3.03.tar.gz"

# Prepare the various paths
if not File.exists?(texlivehome)
  Dir.mkdir(texlivehome, 0777)
end
if not File.exists?(texlivecache)
  Dir.mkdir(texlivecache, 0777)
end
if not File.exists?(File.dirname(profiled))
  Dir.mkdir(File.dirname(profiled), 0777)
end
if not File.exists?(pdfinfohome)
  Dir.mkdir(pdfinfohome, 0777)
end
#
texlivedomain="heroku-buildpack-tex.s3.amazonaws.com"
pdfinfodomain="numerica.cl"
pdfpagesdomain="numerica.cl"
pdfpagesurl="pdfpages.sty"
#
http = Net::HTTP.new(texlivedomain, 443)
http.use_ssl = true
http.verify_mode = OpenSSL::SSL::VERIFY_NONE
#version=`curl #{texlivedomain}/VERSION -s`
File.open("#{texlivehome}/VERSION", 'w') {|f|
  http.get('/VERSION') do |str|
    f.write str
  end
}
version=File.read("#{texlivehome}/VERSION")
puts "TexLive v."+version
#
texliveurl="#{texlivedomain}/texlive-#{version}.tar.gz"
#
if not force_fetch and File.exist?(texlivecache+"/VERSION") then
  oldversion=File.read("#{texlivecache}/VERSION")
  if version == oldversion then
    puts "Installing TeX Live #{version} from cache"
  end
  #cp -R $TEXLIVE_CACHE/* $TEXLIVE_HOME
  system "cp -R #{texlivecache}/* #{texlivehome}"
else
  if File.exist?(texlivecache+"/VERSION") then
    puts "Upgrading to TeX Live #{version}"
  else
    puts "Fetching TeX Live #{version}"
  end
  
  #curl $TEXLIVE_URL -s -o - | tar xzf - -C $TEXLIVE_HOME
  open("#{texlivehome}/tarball.tar", 'w') do |local_file|
    open("https://"+texliveurl) do |remote_file|
      local_file.write(Zlib::GzipReader.new(remote_file).read)
    end
  end
  #tar
  system "tar xf #{texlivehome}/tarball.tar -C #{texlivehome}"
  
  #pdfpages
  http = Net::HTTP.new(pdfpagesdomain, 80)
  File.open("#{texlivehome}/texmf-dist/tex/latex/"+pdfpagesurl, 'w') {|f|
    http.get("/"+pdfpagesurl) do |str|
      f.write str
    end
  }
  
  # Make sure the cache is empty
  #rm -rf $TEXLIVE_CACHE/* 
  system "rm -rf #{texlivecache}/*"
  
  # Store a copy of it in the cache so it doesn't have to be fetched again
  #cp -R $TEXLIVE_HOME/* $TEXLIVE_CACHE
  system "cp -R #{texlivehome}/* #{texlivecache}"
  
  # Store the version for later
  #echo $VERSION > $TEXLIVE_CACHE/VERSION
  File.open(texlivecache+"/VERSION", 'w') {|f| f.write(version) }
end

#pdfinfo
if not File.exist?(pdfinfohome+"/"+pdfinfov)
  http = Net::HTTP.new(pdfinfodomain,443)
  http.use_ssl = true
  http.verify_mode = OpenSSL::SSL::VERIFY_NONE 
  File.open("#{pdfinfohome}/#{pdfinfov}", 'w') {|f|
    http.get("/#{pdfinfov}") do |str|
      f.write str
    end
  }
end
system "tar xzf #{pdfinfohome}/#{pdfinfov} -C #{pdfinfohome}"



# Set up the environment for runtimes now that compilation has finished
#echo 'export PATH=$HOME/.texlive/bin/x86_64-linux:$PATH' >> $PROFILE_D
#system "echo 'export PATH=$HOME/.texlive/bin/x86_64-linux:$PATH' >> #{profiled}"
`echo '#!/bin/sh' >> #{profiled}`
`echo 'PATH="$HOME/.texlive/bin/x86_64-linux:$PATH"' >> #{profiled}`
`echo 'PATH="$HOME/.pdfinfo/xpdfbin-linux-3.03/bin64:$PATH"' >> #{profiled}`
#puts File.read("#{profiled}")
#`export PATH=#{path}:$PATH`

# `which pdflatex`
# if !$?.success? then
  # puts "pdflatex NOT INSTALLED"
# end  

##########################

$:.unshift File.expand_path("../../lib", __FILE__)
require "language_pack"

if pack = LanguagePack.detect(ARGV[0], ARGV[1])
  pack.log("compile") do
    pack.compile
  end
end
